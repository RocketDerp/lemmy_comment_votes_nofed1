How did less rows take more time?

         avg          |  min  |  q1   | median |  q3  |         p95          |  max  | repeats 
----------------------+-------+-------+--------+------+----------------------+-------+---------
 0.008820000000000005 | 0.003 | 0.003 |  0.004 | 0.01 | 0.015649999999999994 | 0.087 |      50
(1 row)

CREATE FUNCTION
    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 13725.293 | 13725.293 | 13725.293 | 13725.293 | 13725.293 | 13725.293 | 13725.293 |       1
(1 row)

CREATE FUNCTION
    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 18012.952 | 18012.952 | 18012.952 | 18012.952 | 18012.952 | 18012.952 | 18012.952 |       1
(1 row)

CREATE FUNCTION
     avg     |     min     |     q1      |   median    |     q3      |     p95     |     max     | repeats 
-------------+-------------+-------------+-------------+-------------+-------------+-------------+---------
 1380922.009 | 1380922.009 | 1380922.009 | 1380922.009 | 1380922.009 | 1380922.009 | 1380922.009 |       1
(1 row)

CREATE FUNCTION
    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 34825.846 | 34825.846 | 34825.846 | 34825.846 | 34825.846 | 34825.846 | 34825.846 |       1
(1 row)

CREATE FUNCTION
   avg    |   min    |    q1    |  median  |    q3    |   p95    |   max    | repeats 
----------+----------+----------+----------+----------+----------+----------+---------
 2732.295 | 2732.295 | 2732.295 | 2732.295 | 2732.295 | 2732.295 | 2732.295 |       1
(1 row)


real	24m10.335s



I didn't change anything but add some output messages, and way faster?

CREATE FUNCTION
         avg          |  min  |  q1   | median |  q3   |         p95          |  max  | repeats 
----------------------+-------+-------+--------+-------+----------------------+-------+---------
 0.003960000000000003 | 0.003 | 0.003 |  0.003 | 0.003 | 0.004549999999999998 | 0.029 |      50
(1 row)

CREATE FUNCTION
   avg    |   min    |    q1    |  median  |    q3    |   p95    |   max    | repeats 
----------+----------+----------+----------+----------+----------+----------+---------
 18690.31 | 18690.31 | 18690.31 | 18690.31 | 18690.31 | 18690.31 | 18690.31 |       1
(1 row)

CREATE FUNCTION
             ?column?             
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 23598.217 | 23598.217 | 23598.217 | 23598.217 | 23598.217 | 23598.217 | 23598.217 |       1
(1 row)

CREATE FUNCTION
              ?column?               
-------------------------------------
 benchmark_fill_comment1 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 204715.29 | 204715.29 | 204715.29 | 204715.29 | 204715.29 | 204715.29 | 204715.29 |       1
(1 row)

CREATE FUNCTION
              ?column?               
-------------------------------------
 benchmark_fill_comment2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 29980.427 | 29980.427 | 29980.427 | 29980.427 | 29980.427 | 29980.427 | 29980.427 |       1
(1 row)

CREATE FUNCTION
                 ?column?                  
-------------------------------------------
 benchmark_fill_comment_reply0 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 3035.07 | 3035.07 | 3035.07 | 3035.07 | 3035.07 | 3035.07 | 3035.07 |       1
(1 row)


real	4m40.117s


delete and rerun

         avg          |  min  |  q1   | median |  q3   |         p95          | max  | repeats 
----------------------+-------+-------+--------+-------+----------------------+------+---------
 0.004160000000000002 | 0.003 | 0.003 |  0.003 | 0.003 | 0.007549999999999998 | 0.03 |      50
(1 row)

CREATE FUNCTION
    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 13440.881 | 13440.881 | 13440.881 | 13440.881 | 13440.881 | 13440.881 | 13440.881 |       1
(1 row)

CREATE FUNCTION
          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 18826.093 | 18826.093 | 18826.093 | 18826.093 | 18826.093 | 18826.093 | 18826.093 |       1
(1 row)

CREATE FUNCTION
           status_message            
-------------------------------------
 benchmark_fill_comment1 kicking off
(1 row)

    avg     |    min     |     q1     |   median   |     q3     |    p95     |    max     | repeats 
------------+------------+------------+------------+------------+------------+------------+---------
 218809.803 | 218809.803 | 218809.803 | 218809.803 | 218809.803 | 218809.803 | 218809.803 |       1
(1 row)

CREATE FUNCTION
           status_message            
-------------------------------------
 benchmark_fill_comment2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 30791.385 | 30791.385 | 30791.385 | 30791.385 | 30791.385 | 30791.385 | 30791.385 |       1
(1 row)

CREATE FUNCTION
              status_message               
-------------------------------------------
 benchmark_fill_comment_reply0 kicking off
(1 row)

   avg    |   min    |    q1    |  median  |    q3    |   p95    |   max    | repeats 
----------+----------+----------+----------+----------+----------+----------+---------
 2521.066 | 2521.066 | 2521.066 | 2521.066 | 2521.066 | 2521.066 | 2521.066 |       1
(1 row)


real	4m44.482s




---------------
reverse order of the two post creation calls

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 19381.957 | 19381.957 | 19381.957 | 19381.957 | 19381.957 | 19381.957 | 19381.957 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 19996.972 | 19996.972 | 19996.972 | 19996.972 | 19996.972 | 19996.972 | 19996.972 |       1
(1 row)

           status_message            
-------------------------------------
 benchmark_fill_comment1 kicking off
(1 row)

    avg     |    min     |     q1     |   median   |     q3     |    p95     |    max     | repeats 
------------+------------+------------+------------+------------+------------+------------+---------
 253836.805 | 253836.805 | 253836.805 | 253836.805 | 253836.805 | 253836.805 | 253836.805 |       1
(1 row)

           status_message            
-------------------------------------
 benchmark_fill_comment2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 35345.686 | 35345.686 | 35345.686 | 35345.686 | 35345.686 | 35345.686 | 35345.686 |       1
(1 row)

              status_message               
-------------------------------------------
 benchmark_fill_comment_reply0 kicking off
(1 row)

   avg    |   min    |    q1    |  median  |    q3    |   p95    |   max    | repeats 
----------+----------+----------+----------+----------+----------+----------+---------
 2933.079 | 2933.079 | 2933.079 | 2933.079 | 2933.079 | 2933.079 | 2933.079 |       1
(1 row)


real	5m31.592s


delete and re-run, much faster, identical statements...

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 19557.467 | 19557.467 | 19557.467 | 19557.467 | 19557.467 | 19557.467 | 19557.467 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 20700.073 | 20700.073 | 20700.073 | 20700.073 | 20700.073 | 20700.073 | 20700.073 |       1
(1 row)

           status_message            
-------------------------------------
 benchmark_fill_comment1 kicking off
(1 row)

    avg     |    min     |     q1     |   median   |     q3     |    p95     |    max     | repeats 
------------+------------+------------+------------+------------+------------+------------+---------
 220957.137 | 220957.137 | 220957.137 | 220957.137 | 220957.137 | 220957.137 | 220957.137 |       1
(1 row)

           status_message            
-------------------------------------
 benchmark_fill_comment2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 33634.334 | 33634.334 | 33634.334 | 33634.334 | 33634.334 | 33634.334 | 33634.334 |       1
(1 row)

              status_message               
-------------------------------------------
 benchmark_fill_comment_reply0 kicking off
(1 row)

   avg    |   min    |    q1    |  median  |    q3    |   p95    |   max    | repeats 
----------+----------+----------+----------+----------+----------+----------+---------
 2499.316 | 2499.316 | 2499.316 | 2499.316 | 2499.316 | 2499.316 | 2499.316 |       1
(1 row)


real	4m57.476s



Even reverting to the original ordrer, slowness re-appears
again, after full delete

 benchmark_fill_post2 kicking off
(1 row)

   avg    |   min    |    q1    |  median  |    q3    |   p95    |   max    | repeats 
----------+----------+----------+----------+----------+----------+----------+---------
 17316.29 | 17316.29 | 17316.29 | 17316.29 | 17316.29 | 17316.29 | 17316.29 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 23191.761 | 23191.761 | 23191.761 | 23191.761 | 23191.761 | 23191.761 | 23191.761 |       1
(1 row)

           status_message            
-------------------------------------
 benchmark_fill_comment1 kicking off
(1 row)

    avg     |    min     |     q1     |   median   |     q3     |    p95     |    max     | repeats 
------------+------------+------------+------------+------------+------------+------------+---------
 241575.997 | 241575.997 | 241575.997 | 241575.997 | 241575.997 | 241575.997 | 241575.997 |       1
(1 row)

           status_message            
-------------------------------------
 benchmark_fill_comment2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 32905.003 | 32905.003 | 32905.003 | 32905.003 | 32905.003 | 32905.003 | 32905.003 |       1
(1 row)

              status_message               
-------------------------------------------
 benchmark_fill_comment_reply0 kicking off
(1 row)

   avg    |   min    |    q1    |  median  |    q3    |   p95    |   max    | repeats 
----------+----------+----------+----------+----------+----------+----------+---------
 2801.323 | 2801.323 | 2801.323 | 2801.323 | 2801.323 | 2801.323 | 2801.323 |       1
(1 row)


real	5m17.905s



rerun again, still slow

 benchmark_fill_post2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 17748.982 | 17748.982 | 17748.982 | 17748.982 | 17748.982 | 17748.982 | 17748.982 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 22563.794 | 22563.794 | 22563.794 | 22563.794 | 22563.794 | 22563.794 | 22563.794 |       1
(1 row)

           status_message            
-------------------------------------
 benchmark_fill_comment1 kicking off
(1 row)

    avg     |    min     |     q1     |   median   |     q3     |    p95     |    max     | repeats 
------------+------------+------------+------------+------------+------------+------------+---------
 251855.586 | 251855.586 | 251855.586 | 251855.586 | 251855.586 | 251855.586 | 251855.586 |       1
(1 row)

           status_message            
-------------------------------------
 benchmark_fill_comment2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 34057.374 | 34057.374 | 34057.374 | 34057.374 | 34057.374 | 34057.374 | 34057.374 |       1
(1 row)

              status_message               
-------------------------------------------
 benchmark_fill_comment_reply0 kicking off
(1 row)

   avg    |   min    |    q1    |  median  |    q3    |   p95    |   max    | repeats 
----------+----------+----------+----------+----------+----------+----------+---------
 2880.583 | 2880.583 | 2880.583 | 2880.583 | 2880.583 | 2880.583 | 2880.583 |       1
(1 row)


real	5m29.226s



tuned PostgreSQL from default values (other than data folder)

data_directory = '/WorkSpot0/postgres_data'		# use data in another directory
hba_file = '/etc/postgresql/15/main/pg_hba.conf'	# host-based authentication file
ident_file = '/etc/postgresql/15/main/pg_ident.conf'	# ident configuration file
external_pid_file = '/var/run/postgresql/15-main.pid'			# write an extra PID file
port = 5432				# (change requires restart)
max_connections = 100			# (change requires restart)
unix_socket_directories = '/var/run/postgresql'	# comma-separated list of directories
ssl = on
ssl_cert_file = '/etc/ssl/certs/ssl-cert-snakeoil.pem'
ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'
shared_buffers = 2048MB			# min 128kB
dynamic_shared_memory_type = posix	# the default is usually the first option
max_wal_size = 2GB
min_wal_size = 120MB
wal_decode_buffer_size = 2048kB		# lookahead window used for prefetching
log_line_prefix = '%m [%p] %q%u@%d '		# special values:
log_timezone = 'America/Phoenix'
cluster_name = '15/main'			# added to process titles if nonempty
datestyle = 'iso, mdy'
timezone = 'America/Phoenix'
lc_messages = 'en_US.UTF-8'			# locale for system error message
lc_monetary = 'en_US.UTF-8'			# locale for monetary formatting
lc_numeric = 'en_US.UTF-8'			# locale for number formatting
lc_time = 'en_US.UTF-8'				# locale for time formatting
default_text_search_config = 'pg_catalog.english'
shared_preload_libraries = 'pg_stat_statements'	# (change requires restart)
pg_stat_statements.track = all
include_dir = 'conf.d'			# include files ending in '.conf' from


didn't make much difference

 benchmark_fill_post2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 16909.609 | 16909.609 | 16909.609 | 16909.609 | 16909.609 | 16909.609 | 16909.609 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 19777.149 | 19777.149 | 19777.149 | 19777.149 | 19777.149 | 19777.149 | 19777.149 |       1
(1 row)

           status_message            
-------------------------------------
 benchmark_fill_comment1 kicking off
(1 row)

    avg     |    min     |     q1     |   median   |     q3     |    p95     |    max     | repeats 
------------+------------+------------+------------+------------+------------+------------+---------
 213730.705 | 213730.705 | 213730.705 | 213730.705 | 213730.705 | 213730.705 | 213730.705 |       1
(1 row)

           status_message            
-------------------------------------
 benchmark_fill_comment2 kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 32022.435 | 32022.435 | 32022.435 | 32022.435 | 32022.435 | 32022.435 | 32022.435 |       1
(1 row)

              status_message               
-------------------------------------------
 benchmark_fill_comment_reply0 kicking off
(1 row)

   avg    |   min    |    q1    |  median  |    q3    |   p95    |   max    | repeats 
----------+----------+----------+----------+----------+----------+----------+---------
 2213.176 | 2213.176 | 2213.176 | 2213.176 | 2213.176 | 2213.176 | 2213.176 |       1
(1 row)


real	4m44.762s
user	0m0.031s
sys	0m0.007s


-------------------
Last run as of time of git commit


CREATE FUNCTION
         avg          |  min  |  q1   | median |  q3   |         p95          |  max  | repeats 
----------------------+-------+-------+--------+-------+----------------------+-------+---------
 0.004060000000000003 | 0.003 | 0.003 |  0.003 | 0.003 | 0.004549999999999998 | 0.035 |      50
(1 row)

CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE TABLE
CREATE TABLE
psql:mass_insert0.sql:516: ERROR:  relation "post_temp0_seq" already exists
 setval 
--------
     34
(1 row)

ALTER TABLE
psql:mass_insert0.sql:521: ERROR:  relation "comment_temp0_seq" already exists
 setval 
--------
       
(1 row)

ALTER TABLE
          status_message          
----------------------------------
 benchmark_fill_post2 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 393.832 | 393.832 | 393.832 | 393.832 | 393.832 | 393.832 | 393.832 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 250.651 | 250.651 | 250.651 | 250.651 | 250.651 | 250.651 | 250.651 |       1
(1 row)

psql:mass_insert0.sql:545: NOTICE:  table "post_temp_id0" does not exist, skipping
DROP TABLE
             status_message             
----------------------------------------
 post targets post_temp_id0 kicking off
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 23.196 | 23.196 | 23.196 | 23.196 | 23.196 | 23.196 | 23.196 |       1
(1 row)

 status_message  
-----------------
 simple comment0
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 265.485 | 265.485 | 265.485 | 265.485 | 265.485 | 265.485 | 265.485 |       1
(1 row)

 status_message  
-----------------
 simple comment1
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 423.234 | 423.234 | 423.234 | 423.234 | 423.234 | 423.234 | 423.234 |       1
(1 row)

 status_message  
-----------------
 simple comment2
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 52232.931 | 52232.931 | 52232.931 | 52232.931 | 52232.931 | 52232.931 | 52232.931 |       1
(1 row)

 status_message  
-----------------
 simple comment3
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 316.985 | 316.985 | 316.985 | 316.985 | 316.985 | 316.985 | 316.985 |       1
(1 row)

 status_message  
-----------------
 simple comment4
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 466.512 | 466.512 | 466.512 | 466.512 | 466.512 | 466.512 | 466.512 |       1
(1 row)

 count  
--------
 125000
(1 row)


real	0m54.536s


===========================
run of code at time of commit


Time:        43.98 s
Ran all test suites matching /simulate_content.spec.ts/i.
:::: jest exited with code 0
good test run
************
************ major SQL script
************ lemmy_alpha
************
CREATE FUNCTION
         avg          |  min  |  q1   | median |   q3    |         p95          |  max  | repeats 
----------------------+-------+-------+--------+---------+----------------------+-------+---------
 0.004600000000000003 | 0.003 | 0.003 |  0.003 | 0.00375 | 0.006099999999999994 | 0.055 |      50
(1 row)

CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE TABLE
CREATE TABLE
CREATE SEQUENCE
 setval 
--------
     34
(1 row)

ALTER TABLE
CREATE SEQUENCE
 setval 
--------
       
(1 row)

ALTER TABLE
          status_message          
----------------------------------
 benchmark_fill_post2 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 533.775 | 533.775 | 533.775 | 533.775 | 533.775 | 533.775 | 533.775 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 273.937 | 273.937 | 273.937 | 273.937 | 273.937 | 273.937 | 273.937 |       1
(1 row)

psql:mass_insert0.sql:545: NOTICE:  table "post_temp_id0" does not exist, skipping
DROP TABLE
             status_message             
----------------------------------------
 post targets post_temp_id0 kicking off
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 26.948 | 26.948 | 26.948 | 26.948 | 26.948 | 26.948 | 26.948 |       1
(1 row)

CREATE EXTENSION
 pg_stat_statements_reset 
--------------------------
 
(1 row)

 status_message  
-----------------
 simple comment0
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 305.053 | 305.053 | 305.053 | 305.053 | 305.053 | 305.053 | 305.053 |       1
(1 row)

 status_message  
-----------------
 simple comment1
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 487.374 | 487.374 | 487.374 | 487.374 | 487.374 | 487.374 | 487.374 |       1
(1 row)

 status_message  
-----------------
 simple comment3
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 315.771 | 315.771 | 315.771 | 315.771 | 315.771 | 315.771 | 315.771 |       1
(1 row)

 status_message  
-----------------
 simple comment4
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 503.396 | 503.396 | 503.396 | 503.396 | 503.396 | 503.396 | 503.396 |       1
(1 row)

 count  
--------
 100000
(1 row)

                     status_message                     
--------------------------------------------------------
 copy post temp table into main post table, kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 64658.239 | 64658.239 | 64658.239 | 64658.239 | 64658.239 | 64658.239 | 64658.239 |       1
(1 row)

                      status_message                       
-----------------------------------------------------------
 copy comment temp table into main post table, kicking off
(1 row)

     avg     |     min     |     q1      |   median    |     q3      |     p95     |     max     | repeats 
-------------+-------------+-------------+-------------+-------------+-------------+-------------+---------
 2183758.383 | 2183758.383 | 2183758.383 | 2183758.383 | 2183758.383 | 2183758.383 | 2183758.383 |       1
(1 row)


real	37m31.054s



==========================
Run with revised FUNCTION on post_aggregates for comments.
Run against current .sql file content


Time:        44.156 s
Ran all test suites matching /simulate_content.spec.ts/i.
:::: jest exited with code 0
good test run
************
************ major SQL script
************ lemmy_alpha
************
CREATE FUNCTION
         avg          |  min  |  q1   | median |  q3   |         p95          |  max  | repeats 
----------------------+-------+-------+--------+-------+----------------------+-------+---------
 0.005180000000000003 | 0.004 | 0.004 |  0.004 | 0.004 | 0.006549999999999998 | 0.037 |      50
(1 row)

CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE TABLE
CREATE TABLE
CREATE SEQUENCE
 setval 
--------
     34
(1 row)

ALTER TABLE
CREATE SEQUENCE
 setval 
--------
       
(1 row)

ALTER TABLE
          status_message          
----------------------------------
 benchmark_fill_post2 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 671.717 | 671.717 | 671.717 | 671.717 | 671.717 | 671.717 | 671.717 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 307.915 | 307.915 | 307.915 | 307.915 | 307.915 | 307.915 | 307.915 |       1
(1 row)

psql:mass_insert0.sql:627: NOTICE:  table "post_temp_id0" does not exist, skipping
DROP TABLE
             status_message             
----------------------------------------
 post targets post_temp_id0 kicking off
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 27.216 | 27.216 | 27.216 | 27.216 | 27.216 | 27.216 | 27.216 |       1
(1 row)

CREATE EXTENSION
 pg_stat_statements_reset 
--------------------------
 
(1 row)

 status_message  
-----------------
 simple comment0
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 352.771 | 352.771 | 352.771 | 352.771 | 352.771 | 352.771 | 352.771 |       1
(1 row)

 status_message  
-----------------
 simple comment1
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 546.263 | 546.263 | 546.263 | 546.263 | 546.263 | 546.263 | 546.263 |       1
(1 row)

 status_message  
-----------------
 simple comment3
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 348.694 | 348.694 | 348.694 | 348.694 | 348.694 | 348.694 | 348.694 |       1
(1 row)

 status_message  
-----------------
 simple comment4
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 578.878 | 578.878 | 578.878 | 578.878 | 578.878 | 578.878 | 578.878 |       1
(1 row)

 count  
--------
 100000
(1 row)

                     status_message                     
--------------------------------------------------------
 copy post temp table into main post table, kicking off
(1 row)

   avg    |   min    |    q1    |  median  |    q3    |   p95    |   max    | repeats 
----------+----------+----------+----------+----------+----------+----------+---------
 69296.09 | 69296.09 | 69296.09 | 69296.09 | 69296.09 | 69296.09 | 69296.09 |       1
(1 row)

                      status_message                       
-----------------------------------------------------------
 copy comment temp table into main post table, kicking off
(1 row)

    avg     |    min     |     q1     |   median   |     q3     |    p95     |    max     | repeats 
------------+------------+------------+------------+------------+------------+------------+---------
 732875.919 | 732875.919 | 732875.919 | 732875.919 | 732875.919 | 732875.919 | 732875.919 |       1
(1 row)

psql:mass_insert0.sql:739: ERROR:  syntax error at or near "action"
LINE 72:  action going on for aggregates must make this slower and wh...
          ^
psql:mass_insert0.sql:740: ERROR:  duplicate key value violates unique constraint "post_pkey"
DETAIL:  Key (id)=(35) already exists.
CONTEXT:  SQL statement "INSERT INTO post SELECT * FROM post_temp0"
PL/pgSQL function bench(text,integer,integer) line 20 at EXECUTE
                      status_message                       
-----------------------------------------------------------
 copy comment temp table into main post table, kicking off
(1 row)

psql:mass_insert0.sql:742: ERROR:  duplicate key value violates unique constraint "comment_pkey"
DETAIL:  Key (id)=(1) already exists.
CONTEXT:  SQL statement "INSERT INTO comment SELECT * FROM comment_temp0"
PL/pgSQL function bench(text,integer,integer) line 20 at EXECUTE

real	13m25.218s


=========================
another run, cvurrent .sql file

Time:        42.957 s
Ran all test suites matching /simulate_content.spec.ts/i.
:::: jest exited with code 0
good test run
************
************ major SQL script
************ lemmy_alpha
************
CREATE FUNCTION
         avg          |  min  |  q1   | median |  q3   |         p95          | max  | repeats 
----------------------+-------+-------+--------+-------+----------------------+------+---------
 0.005360000000000003 | 0.003 | 0.003 |  0.003 | 0.006 | 0.009549999999999998 | 0.04 |      50
(1 row)

CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE TABLE
CREATE TABLE
CREATE SEQUENCE
 setval 
--------
     34
(1 row)

ALTER TABLE
CREATE SEQUENCE
 setval 
--------
       
(1 row)

ALTER TABLE
          status_message          
----------------------------------
 benchmark_fill_post2 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 567.257 | 567.257 | 567.257 | 567.257 | 567.257 | 567.257 | 567.257 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 290.358 | 290.358 | 290.358 | 290.358 | 290.358 | 290.358 | 290.358 |       1
(1 row)

psql:mass_insert0.sql:629: NOTICE:  table "post_temp_id0" does not exist, skipping
DROP TABLE
             status_message             
----------------------------------------
 post targets post_temp_id0 kicking off
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 30.077 | 30.077 | 30.077 | 30.077 | 30.077 | 30.077 | 30.077 |       1
(1 row)

CREATE EXTENSION
 pg_stat_statements_reset 
--------------------------
 
(1 row)

 status_message  
-----------------
 simple comment0
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 331.322 | 331.322 | 331.322 | 331.322 | 331.322 | 331.322 | 331.322 |       1
(1 row)

 status_message  
-----------------
 simple comment1
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 515.564 | 515.564 | 515.564 | 515.564 | 515.564 | 515.564 | 515.564 |       1
(1 row)

 status_message  
-----------------
 simple comment3
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 326.675 | 326.675 | 326.675 | 326.675 | 326.675 | 326.675 | 326.675 |       1
(1 row)

 status_message  
-----------------
 simple comment4
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 520.419 | 520.419 | 520.419 | 520.419 | 520.419 | 520.419 | 520.419 |       1
(1 row)

 count  
--------
 100000
(1 row)

                     status_message                     
--------------------------------------------------------
 copy post temp table into main post table, kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 67860.971 | 67860.971 | 67860.971 | 67860.971 | 67860.971 | 67860.971 | 67860.971 |       1
(1 row)

                      status_message                       
-----------------------------------------------------------
 copy comment temp table into main post table, kicking off
(1 row)

    avg     |    min     |     q1     |   median   |     q3     |    p95     |    max     | repeats 
------------+------------+------------+------------+------------+------------+------------+---------
 792345.757 | 792345.757 | 792345.757 | 792345.757 | 792345.757 | 792345.757 | 792345.757 |       1
(1 row)


real	14m22.973s


=====================
latest .sql

Performance looks good, and lemmy-ui browsing of output to spot check looks good.

 PASS  src/simulate_content.spec.ts (40.432 s)
  ✓ create usernames (27836 ms)
  ✓ create communities (2347 ms)
  ✓ users update their profile (443 ms)
  ✓ all follow 2 communities (1444 ms)
  ✓ all follow personal communities (331 ms)
  ✓ create welcome posts by members (2854 ms)
  ✓ create stress-test communities (2737 ms)
  ○ skipped replies and upvotes to welcome posts by members

Test Suites: 1 passed, 1 total
Tests:       1 skipped, 7 passed, 8 total
Snapshots:   0 total
Time:        40.471 s, estimated 41 s
Ran all test suites matching /simulate_content.spec.ts/i.
:::: jest exited with code 0
good test run
************
************ major SQL script
************ lemmy_alpha
************
SET
CREATE FUNCTION
         avg          |  min  |  q1   | median |  q3   |         p95          |  max  | repeats 
----------------------+-------+-------+--------+-------+----------------------+-------+---------
 0.004660000000000003 | 0.003 | 0.003 |  0.003 | 0.004 | 0.008549999999999997 | 0.037 |      50
(1 row)

CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE TABLE
CREATE TABLE
CREATE SEQUENCE
 setval 
--------
     34
(1 row)

ALTER TABLE
CREATE SEQUENCE
 setval 
--------
       
(1 row)

ALTER TABLE
          status_message          
----------------------------------
 benchmark_fill_post2 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 514.682 | 514.682 | 514.682 | 514.682 | 514.682 | 514.682 | 514.682 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 262.002 | 262.002 | 262.002 | 262.002 | 262.002 | 262.002 | 262.002 |       1
(1 row)

psql:mass_insert0.sql:547: NOTICE:  table "post_temp_id0" does not exist, skipping
DROP TABLE
             status_message             
----------------------------------------
 post targets post_temp_id0 kicking off
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 26.958 | 26.958 | 26.958 | 26.958 | 26.958 | 26.958 | 26.958 |       1
(1 row)

  id   
-------
 42647
 17541
 59410
 53288
 31616
 22499
 42427
  9793
 32939
 13271
(10 rows)

CREATE EXTENSION
 pg_stat_statements_reset 
--------------------------
 
(1 row)

 status_message  
-----------------
 simple comment0
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 288.732 | 288.732 | 288.732 | 288.732 | 288.732 | 288.732 | 288.732 |       1
(1 row)

 status_message  
-----------------
 simple comment1
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 469.084 | 469.084 | 469.084 | 469.084 | 469.084 | 469.084 | 469.084 |       1
(1 row)

 status_message  
-----------------
 simple comment3
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 304.894 | 304.894 | 304.894 | 304.894 | 304.894 | 304.894 | 304.894 |       1
(1 row)

 status_message  
-----------------
 simple comment4
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 479.983 | 479.983 | 479.983 | 479.983 | 479.983 | 479.983 | 479.983 |       1
(1 row)

 count  
--------
 100000
(1 row)

                     status_message                     
--------------------------------------------------------
 copy post temp table into main post table, kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 61430.115 | 61430.115 | 61430.115 | 61430.115 | 61430.115 | 61430.115 | 61430.115 |       1
(1 row)

                      status_message                       
-----------------------------------------------------------
 copy comment temp table into main post table, kicking off
(1 row)

    avg     |    min     |     q1     |   median   |     q3     |    p95     |    max     | repeats 
------------+------------+------------+------------+------------+------------+------------+---------
 427138.165 | 427138.165 | 427138.165 | 427138.165 | 427138.165 | 427138.165 | 427138.165 |       1
(1 row)

                                ?column?                                
------------------------------------------------------------------------
 PostgreSQL seems to be confuused if next section is all commented out?
(1 row)


real	8m11.111s



--------------------------------------

 PASS  src/simulate_content.spec.ts (42.08 s)
  ✓ create usernames (28744 ms)
  ✓ create communities (2592 ms)
  ✓ users update their profile (418 ms)
  ✓ all follow 2 communities (1362 ms)
  ✓ all follow personal communities (334 ms)
  ✓ create welcome posts by members (2636 ms)
  ✓ create stress-test communities (2864 ms)
  ○ skipped replies and upvotes to welcome posts by members

Test Suites: 1 passed, 1 total
Tests:       1 skipped, 7 passed, 8 total
Snapshots:   0 total
Time:        42.121 s
Ran all test suites matching /simulate_content.spec.ts/i.
:::: jest exited with code 0
good test run
************
************ major SQL script
************ lemmy_alpha
************
SET
CREATE FUNCTION
         avg          |  min  |  q1   | median |  q3   |         p95          |  max  | repeats 
----------------------+-------+-------+--------+-------+----------------------+-------+---------
 0.005840000000000003 | 0.003 | 0.003 |  0.003 | 0.004 | 0.010749999999999985 | 0.074 |      50
(1 row)

CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE TABLE
CREATE TABLE
CREATE SEQUENCE
 setval 
--------
     34
(1 row)

ALTER TABLE
CREATE SEQUENCE
 setval 
--------
       
(1 row)

ALTER TABLE
          status_message          
----------------------------------
 benchmark_fill_post2 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 619.629 | 619.629 | 619.629 | 619.629 | 619.629 | 619.629 | 619.629 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 311.034 | 311.034 | 311.034 | 311.034 | 311.034 | 311.034 | 311.034 |       1
(1 row)

psql:mass_insert0.sql:725: NOTICE:  table "post_temp_id0" does not exist, skipping
DROP TABLE
             status_message             
----------------------------------------
 post targets post_temp_id0 kicking off
(1 row)

  avg  |  min  |  q1   | median |  q3   |  p95  |  max  | repeats 
-------+-------+-------+--------+-------+-------+-------+---------
 32.36 | 32.36 | 32.36 |  32.36 | 32.36 | 32.36 | 32.36 |       1
(1 row)

  id   
-------
 14970
 52264
  4372
 24488
 35483
   945
   617
  1508
 20755
  9558
(10 rows)

CREATE EXTENSION
 pg_stat_statements_reset 
--------------------------
 
(1 row)

 status_message  
-----------------
 simple comment0
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 16.838 | 16.838 | 16.838 | 16.838 | 16.838 | 16.838 | 16.838 |       1
(1 row)

 status_message  
-----------------
 simple comment1
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 34.741 | 34.741 | 34.741 | 34.741 | 34.741 | 34.741 | 34.741 |       1
(1 row)

 status_message  
-----------------
 simple comment3
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 15.711 | 15.711 | 15.711 | 15.711 | 15.711 | 15.711 | 15.711 |       1
(1 row)

 status_message  
-----------------
 simple comment4
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 18.795 | 18.795 | 18.795 | 18.795 | 18.795 | 18.795 | 18.795 |       1
(1 row)

                    status_message                    
------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0 kicking off
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 41.876 | 41.876 | 41.876 | 41.876 | 41.876 | 41.876 | 41.876 |       1
(1 row)

                                status_message                                
------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_hugecommunity0 kicking off, 12 runs
(1 row)

        avg        |  min   |   q1    | median  |   q3    |   p95    |  max   | repeats 
-------------------+--------+---------+---------+---------+----------+--------+---------
 66.65749999999998 | 60.748 | 65.5375 | 66.9825 | 68.4525 | 69.01545 | 69.291 |      12
(1 row)

                                status_message                                
------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_hugecommunity1 kicking off, 12 runs
(1 row)

        avg        |  min  |   q1    | median  |        q3         |   p95    |  max  | repeats 
-------------------+-------+---------+---------+-------------------+----------+-------+---------
 80.65525000000001 | 65.11 | 81.4855 | 82.2415 | 82.77125000000001 | 83.54695 | 83.74 |      12
(1 row)

                            status_message                            
----------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0 ROUND 2 kicking off 20 runs
(1 row)

   avg   |  min   |   q1    | median  |        q3         |        p95        |  max   | repeats 
---------+--------+---------+---------+-------------------+-------------------+--------+---------
 77.0121 | 74.453 | 76.1295 | 76.8375 | 77.60674999999999 | 79.97330000000001 | 80.758 |      20
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 1 kicking off 5 runs level 3
(1 row)

        avg        |  min   |   q1   | median |   q3   |   p95   |  max   | repeats 
-------------------+--------+--------+--------+--------+---------+--------+---------
 88.99680000000001 | 87.355 | 87.569 | 89.847 | 89.968 | 90.1896 | 90.245 |       5
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 2 kicking off 5 runs level 4
(1 row)

   avg   |   min   |   q1   | median  |   q3    |   p95    |   max   | repeats 
---------+---------+--------+---------+---------+----------+---------+---------
 120.077 | 116.693 | 116.75 | 117.257 | 117.796 | 129.0704 | 131.889 |       5
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 3 kicking off 5 runs level 5
(1 row)

   avg    |   min   |   q1    | median  |   q3    |   p95    |   max   | repeats 
----------+---------+---------+---------+---------+----------+---------+---------
 123.1982 | 121.509 | 121.764 | 122.174 | 123.345 | 126.4282 | 127.199 |       5
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 4 kicking off 3 runs level 6
(1 row)

        avg         |   min   |   q1    | median  |         q3         |   p95    |   max   | repeats 
--------------------+---------+---------+---------+--------------------+----------+---------+---------
 134.13833333333332 | 131.331 | 131.438 | 131.545 | 135.54199999999997 | 138.7396 | 139.539 |       3
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 5 kicking off 3 runs level 7
(1 row)

        avg         |   min   |  q1   | median  |   q3    |   p95    |   max   | repeats 
--------------------+---------+-------+---------+---------+----------+---------+---------
 142.13033333333334 | 138.935 | 139.4 | 139.865 | 143.728 | 146.8184 | 147.591 |       3
(1 row)

                                      status_message                                       
-------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 5 kicking off 20 runs level 8
(1 row)

        avg         |   min   |    q1     |  median  |         q3         |        p95         |   max   | repeats 
--------------------+---------+-----------+----------+--------------------+--------------------+---------+---------
 180.54065000000003 | 173.845 | 176.99725 | 178.0405 | 179.79025000000001 | 188.70040000000003 | 223.687 |      20
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 5 kicking off 5 runs level 9
(1 row)

   avg    |   min   |   q1   | median  |   q3    |   p95    |   max   | repeats 
----------+---------+--------+---------+---------+----------+---------+---------
 201.1932 | 184.956 | 192.27 | 197.496 | 206.666 | 220.9956 | 224.578 |       5
(1 row)

                                      status_message                                       
-------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 5 kicking off 5 runs level 10
(1 row)

   avg    |   min   |   q1   | median  |   q3    |   p95    |   max   | repeats 
----------+---------+--------+---------+---------+----------+---------+---------
 196.7672 | 195.401 | 195.45 | 195.721 | 197.756 | 199.1576 | 199.508 |       5
(1 row)

                                      status_message                                       
-------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 5 kicking off 5 runs level 11
(1 row)

   avg    |   min   |   q1    | median  |   q3    |   p95    |   max   | repeats 
----------+---------+---------+---------+---------+----------+---------+---------
 223.5616 | 214.801 | 218.741 | 218.851 | 231.573 | 233.3882 | 233.842 |       5
(1 row)

 count  
--------
 312684
(1 row)

 comment_temp0_path_max_level 
------------------------------
                           13
(1 row)

                     status_message                     
--------------------------------------------------------
 copy post temp table into main post table, kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 88605.796 | 88605.796 | 88605.796 | 88605.796 | 88605.796 | 88605.796 | 88605.796 |       1
(1 row)

                      status_message                       
-----------------------------------------------------------
 copy comment temp table into main post table, kicking off
(1 row)

     avg     |     min     |     q1      |   median    |     q3      |     p95     |     max     | repeats 
-------------+-------------+-------------+-------------+-------------+-------------+-------------+---------
 3233553.444 | 3233553.444 | 3233553.444 | 3233553.444 | 3233553.444 | 3233553.444 | 3233553.444 |       1
(1 row)

        status_message        
------------------------------
 child_count_for_all_comments
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 18166.782 | 18166.782 | 18166.782 | 18166.782 | 18166.782 | 18166.782 | 18166.782 |       1
(1 row)

 comments_with_child_count_rows 
--------------------------------
                          35623
(1 row)

                                ?column?                                
------------------------------------------------------------------------
 PostgreSQL seems to be confuused if next section is all commented out?
(1 row)


real	55m54.430s


=================

Run with the code as seen now, fresly deleted and recreated PostgreSQL data directory


 PASS  src/simulate_content.spec.ts (184.073 s)
  ✓ create usernames (29910 ms)
  ✓ create communities (2524 ms)
  ✓ users update their profile (539 ms)
  ✓ all follow 2 communities (1440 ms)
  ✓ all follow personal communities (354 ms)
  ✓ create welcome posts by members (2848 ms)
  ✓ replies and upvotes to welcome posts by members (140847 ms)
  ✓ create stress-test communities (2927 ms)

Test Suites: 1 passed, 1 total
Tests:       8 passed, 8 total
Snapshots:   0 total
Time:        184.124 s
Ran all test suites matching /simulate_content.spec.ts/i.
:::: jest exited with code 0
good test run
************
************ major SQL script
************ lemmy_alpha
************
SET
CREATE FUNCTION
         avg          |  min  |  q1   | median |  q3   |         p95          |  max  | repeats 
----------------------+-------+-------+--------+-------+----------------------+-------+---------
 0.004120000000000002 | 0.003 | 0.003 |  0.003 | 0.004 | 0.006099999999999994 | 0.031 |      50
(1 row)

CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE FUNCTION
CREATE TABLE
CREATE TABLE
CREATE SEQUENCE
 setval 
--------
     36
(1 row)

ALTER TABLE
CREATE SEQUENCE
 setval 
--------
   1296
(1 row)

ALTER TABLE
          status_message          
----------------------------------
 benchmark_fill_post2 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 441.091 | 441.091 | 441.091 | 441.091 | 441.091 | 441.091 | 441.091 |       1
(1 row)

          status_message          
----------------------------------
 benchmark_fill_post3 kicking off
(1 row)

   avg   |   min   |   q1    | median  |   q3    |   p95   |   max   | repeats 
---------+---------+---------+---------+---------+---------+---------+---------
 276.717 | 276.717 | 276.717 | 276.717 | 276.717 | 276.717 | 276.717 |       1
(1 row)

psql:mass_insert0.sql:725: NOTICE:  table "post_temp_id0" does not exist, skipping
DROP TABLE
             status_message             
----------------------------------------
 post targets post_temp_id0 kicking off
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 26.779 | 26.779 | 26.779 | 26.779 | 26.779 | 26.779 | 26.779 |       1
(1 row)

  id   
-------
 41979
 50960
 48051
 28139
 47791
 52413
  9652
 53384
 18891
 29553
(10 rows)

CREATE EXTENSION
 pg_stat_statements_reset 
--------------------------
 
(1 row)

 status_message  
-----------------
 simple comment0
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 11.145 | 11.145 | 11.145 | 11.145 | 11.145 | 11.145 | 11.145 |       1
(1 row)

 status_message  
-----------------
 simple comment1
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 24.928 | 24.928 | 24.928 | 24.928 | 24.928 | 24.928 | 24.928 |       1
(1 row)

 status_message  
-----------------
 simple comment3
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 10.222 | 10.222 | 10.222 | 10.222 | 10.222 | 10.222 | 10.222 |       1
(1 row)

 status_message  
-----------------
 simple comment4
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 14.885 | 14.885 | 14.885 | 14.885 | 14.885 | 14.885 | 14.885 |       1
(1 row)

                    status_message                    
------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0 kicking off
(1 row)

  avg   |  min   |   q1   | median |   q3   |  p95   |  max   | repeats 
--------+--------+--------+--------+--------+--------+--------+---------
 33.469 | 33.469 | 33.469 | 33.469 | 33.469 | 33.469 | 33.469 |       1
(1 row)

                                status_message                                
------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_hugecommunity0 kicking off, 12 runs
(1 row)

   avg    |  min   |    q1    | median  |    q3    |   p95    |  max   | repeats 
----------+--------+----------+---------+----------+----------+--------+---------
 54.15275 | 45.512 | 53.94925 | 54.6265 | 55.23075 | 57.14685 | 58.705 |      12
(1 row)

                                status_message                                
------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_hugecommunity1 kicking off, 12 runs
(1 row)

        avg        |  min   |         q1         | median |    q3    |   p95    |  max  | repeats 
-------------------+--------+--------------------+--------+----------+----------+-------+---------
 62.68216666666667 | 60.468 | 61.292249999999996 | 61.931 | 62.61375 | 67.60115 | 69.09 |      12
(1 row)

                            status_message                            
----------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0 ROUND 2 kicking off 20 runs
(1 row)

        avg         |  min   |   q1    | median  |    q3    |        p95         |  max   | repeats 
--------------------+--------+---------+---------+----------+--------------------+--------+---------
 63.100849999999994 | 61.668 | 62.4985 | 63.0295 | 63.41075 | 63.844500000000004 | 65.982 |      20
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 1 kicking off 5 runs level 3
(1 row)

        avg        |  min   |   q1   | median |   q3   |   p95   |  max   | repeats 
-------------------+--------+--------+--------+--------+---------+--------+---------
 85.13220000000001 | 78.811 | 82.139 | 84.716 | 86.617 | 92.0258 | 93.378 |       5
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 2 kicking off 5 runs level 4
(1 row)

        avg        |  min   |   q1   | median |   q3   |   p95   |   max   | repeats 
-------------------+--------+--------+--------+--------+---------+---------+---------
 96.89200000000001 | 93.953 | 93.976 | 94.885 | 95.143 | 104.231 | 106.503 |       5
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 3 kicking off 5 runs level 5
(1 row)

        avg         |  min   |   q1    | median  |   q3    |   p95    |   max   | repeats 
--------------------+--------+---------+---------+---------+----------+---------+---------
 102.49839999999999 | 99.922 | 100.605 | 100.732 | 103.202 | 107.0652 | 108.031 |       5
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 4 kicking off 3 runs level 6
(1 row)

        avg         | min |    q1    | median  |    q3    |   p95    |   max   | repeats 
--------------------+-----+----------+---------+----------+----------+---------+---------
 110.83833333333332 | 108 | 108.9865 | 109.973 | 112.2575 | 114.0851 | 114.542 |       3
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 5 kicking off 3 runs level 7
(1 row)

        avg         |   min   |    q1    | median  |    q3    |   p95    |   max   | repeats 
--------------------+---------+----------+---------+----------+----------+---------+---------
 118.61266666666667 | 115.229 | 115.7415 | 116.254 | 120.3045 | 123.5449 | 124.355 |       3
(1 row)

                                      status_message                                       
-------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 5 kicking off 20 runs level 8
(1 row)

    avg    |   min   |    q1     |       median       |    q3     |   p95    |   max   | repeats 
-----------+---------+-----------+--------------------+-----------+----------+---------+---------
 149.49755 | 142.864 | 145.42475 | 147.60199999999998 | 153.02675 | 158.6813 | 158.877 |      20
(1 row)

                                      status_message                                      
------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 5 kicking off 5 runs level 9
(1 row)

        avg         |  min   |   q1    | median |   q3   |        p95         |   max   | repeats 
--------------------+--------+---------+--------+--------+--------------------+---------+---------
 158.57420000000002 | 154.94 | 156.555 | 157.83 | 158.87 | 163.51479999999998 | 164.676 |       5
(1 row)

                                      status_message                                       
-------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 5 kicking off 5 runs level 10
(1 row)

   avg    |   min   |   q1   | median  |   q3    |   p95   |   max   | repeats 
----------+---------+--------+---------+---------+---------+---------+---------
 177.8074 | 169.638 | 174.87 | 177.236 | 180.029 | 185.817 | 187.264 |       5
(1 row)

                                      status_message                                       
-------------------------------------------------------------------------------------------
 benchmark_fill_comment_reply_using_temp0_extendbranch ROUND 5 kicking off 5 runs level 11
(1 row)

   avg    |   min   |   q1    | median  |   q3    |   p95    |   max   | repeats 
----------+---------+---------+---------+---------+----------+---------+---------
 197.3674 | 189.197 | 192.149 | 192.382 | 204.248 | 207.9384 | 208.861 |       5
(1 row)

 count  
--------
 313617
(1 row)

 comment_temp0_path_max_level 
------------------------------
                           13
(1 row)

                     status_message                     
--------------------------------------------------------
 copy post temp table into main post table, kicking off
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 95953.322 | 95953.322 | 95953.322 | 95953.322 | 95953.322 | 95953.322 | 95953.322 |       1
(1 row)

                      status_message                       
-----------------------------------------------------------
 copy comment temp table into main post table, kicking off
(1 row)

     avg     |     min     |     q1      |   median    |     q3      |     p95     |     max     | repeats 
-------------+-------------+-------------+-------------+-------------+-------------+-------------+---------
 3336308.709 | 3336308.709 | 3336308.709 | 3336308.709 | 3336308.709 | 3336308.709 | 3336308.709 |       1
(1 row)

        status_message        
------------------------------
 child_count_for_all_comments
(1 row)

    avg    |    min    |    q1     |  median   |    q3     |    p95    |    max    | repeats 
-----------+-----------+-----------+-----------+-----------+-----------+-----------+---------
 16908.916 | 16908.916 | 16908.916 | 16908.916 | 16908.916 | 16908.916 | 16908.916 |       1
(1 row)

 comments_with_child_count_rows 
--------------------------------
                          34711
(1 row)

                                ?column?                                
------------------------------------------------------------------------
 PostgreSQL seems to be confuused if next section is all commented out?
(1 row)


real	57m40.957s

